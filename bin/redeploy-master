#!/bin/bash

HOME_PREF=/home/docklet

[[ "`whoami`" != "root" ]] && echo "Root previledge required!" && exit 1

apt-get install lxc ethtool python-pampy bridge-utils libapparmor1

weave stop >/dev/null 2>&1 || true

killall docker >/dev/null 2>&1
killall etcd >/dev/null 2>&1

umount -l /var/lib/docker/aufs/mnt/* >/dev/null 2>&1
umount -l /var/lib/docker/aufs/diff/* >/dev/null 2>&1
umount -l /var/lib/docker/aufs/ >/dev/null 2>&1

rm -rf /var/lib/docker

nohup docker -d -e lxc >/dev/null 2>&1 &

cd / && nohup etcd >/dev/null 2>&1 &

sleep 2

weave launch

mkdir -p ${HOME_PREF}/images

ham load /usr/local/bin/pub_root_base.tgz

