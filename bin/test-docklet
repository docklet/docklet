#!/bin/bash

set -e

. /etc/docklet/docklet.conf

function log {
	echo -e "\033[34m$@\033[0m\n"
}

clear

log "# this is standard login interface .."
curl "http://${PORTAL_HTTP}:8000/user/login?name=root&pass=any"

curl "http://${PORTAL_HTTP}:8000/user/login?name=root&pass=any" 2>/dev/null | python -mjson.tool | grep openssh.: | awk -F\" '{print $4}' > ${HOME}/root.key
sed -i 's/\\n/\n/g' ${HOME}/root.key
chmod go-rw ${HOME}/root.key

read ; clear

log "# this is portals list .."
curl -F user=root -F key=@${HOME}/root.key "http://${PORTAL_HTTP}:8000/portals"
read ; clear

log "# this is images list .."
curl -F user=root -F key=@${HOME}/root.key "http://${PORTAL_HTTP}:8000/images"
read ; clear

log "# creating clusters .."
curl -F image=root_base -F portal=172.31.0.128 -F user=root -F key=@${HOME}/root.key "http://${PORTAL_HTTP}:8000/clusters/create"
read ; clear

log "# cluster information .."
curl -F user=root -F key=@${HOME}/root.key "http://${PORTAL_HTTP}:8000/clusters/1"
read ; clear

log "# scaling clusters .."
curl -F user=root -F key=@${HOME}/root.key "http://${PORTAL_HTTP}:8000/clusters/1/scaleup"
read ; clear

log "# try login clusters 1 times, nodes size should be 2.."
ssh root@172.31.0.128 -i ${HOME}/root.key
clear

log "# restart clusters .."
curl -F user=root -F key=@${HOME}/root.key "http://${PORTAL_HTTP}:8000/clusters/1/restart"
read ; clear

log "# try login clusters 2 times, nodes size should be 2.."
ssh root@172.31.0.128 -i ${HOME}/root.key
clear

log "# remove clusters .."
curl -F user=root -F key=@${HOME}/root.key "http://${PORTAL_HTTP}:8000/clusters/1/commit"
read ; clear

echo "All tests done."
