#!/bin/bash

# Example:
# WORK_ON=192.168.4.231 USER_NAME=root IMAGE=ssh NATIVE_IP=10.0.0.254 BRIDGE_IP=192.168.4.200 BRIDGE_GW=192.168.4.2 BRIDGE_DEV=br1 cave
# WORK_ON=192.168.4.231 USER_NAME=root IMAGE=ssh NATIVE_IP=10.0.0.1 cave
# WORK_ON=192.168.4.232 USER_NAME=root IMAGE=ssh NATIVE_IP=10.0.0.2 cave
#
#
# ssh root@192.168.4.200
# >> spark-shell --master spark://nat-master:7077
# use: /home/docker/root/.ssh/id_rsa

. /etc/docklet/docklet.conf

HOME_PREF=${NFS_PREFIX}

[[ "`whoami`" != "root" ]] && echo "Root previledge required!" && exit 1

[[ "${NAT_ID}" == "" ]] && echo "NAT_ID not specified!" && exit 1
[[ "${HOST_NAME}" == "" ]] && echo "HOST_NAME not specified!" && exit 1
[[ "${USER_NAME}" == "" ]] && echo "USER_NAME not specified!" && exit 1
[[ "${IMAGE}" == "" ]] && echo "IMAGE not specified!" && exit 1
[[ "${NATIVE_IP}" == "" ]] && echo "NATIVE_IP not specified!" && exit 1
[[ "${WORK_ON}" == "" ]] && echo "WORK_ON not specified!" && exit 1
[[ "${MOD}" == "" ]] && echo "MOD not specified!" && exit 1

HOST_PROP=$(echo ${NATIVE_IP} | awk -F. '{print $4}')
MASTER_IP=$(basename ${NATIVE_IP} ${HOST_PROP})"254"

if [[ "$HOST_PROP" == "254" ]]; then
	[[ "${BRIDGE_IP}" == "" ]] && echo "BRIDGE_IP not specified!" && exit 1
	[[ "${BRIDGE_GW}" == "" ]] && echo "BRIDGE_GW not specified!" && exit 1
	[[ "${BRIDGE_DEV}" == "" ]] && echo "BRIDGE_DEV not specified!" && exit 1
fi

[[ "${USER_NAME}" != "root" ]] && [[ "${OPTS}" != "" ]] && echo "extra opts now allowed for ${USER_NAME}!"


if [[ "$HOST_PROP" == "254" ]]; then
	NET_CONF="--net=none --lxc-conf=\"lxc.network.type=veth\" --lxc-conf=\"lxc.network.ipv4=${BRIDGE_IP}/24\" --lxc-conf=\"lxc.network.ipv4.gateway=${BRIDGE_GW}\" --lxc-conf=\"lxc.network.link=${BRIDGE_DEV}\" --lxc-conf=\"lxc.network.name=eth0\" --lxc-conf=\"lxc.network.flags=up\""
else
	NET_CONF='--net=bridge'
fi

NAT_ID=${NAT_ID} USER_NAME=${USER_NAME} stone >/dev/null

[[ "${MOD}" != "skip" ]] && ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${WORK_ON} ham pull_3v ${MOD}_${IMAGE} > /dev/stderr

if [[ "`[[ -e /etc/lsb-release ]] && cat /etc/lsb-release | grep Ubuntu`" != "" ]]; then
	FOLK_FLAG="--lxc-conf=\"lxc.cgroup.memory.kmem.limit_in_bytes=${FOLK_BOMB_SPACE}\" --lxc-conf=\"lxc.cgroup.cpu.cfs_quota_us=${CPU_SHARE_QUOTA_US}\""
fi

echo "[CAVE] ${WORK_ON} docklet-weave run ${NATIVE_IP}/24 \
		-v ${HOME_PREF}/${USER_NAME}/hosts-${NAT_ID}:/etc/hosts \
		-v ${HOME_PREF}/${USER_NAME}/container-init:/sbin/initctl \
		-v ${HOME_PREF}/${USER_NAME}/container-docklet:/usr/bin/docklet \
		-v ${HOME_PREF}/${USER_NAME}/home:/root \
		--lxc-conf="lxc.cgroup.cpu.cfs_quota_us=100000" \
		-m ${TOTAL_MEMORY_LIMIT} -it ${NET_CONF} -h ${HOST_NAME} ${FOLK_FLAG} ${OPTS} ${IMAGE} /sbin/initctl ${NATIVE_IP} ${MASTER_IP}" >/dev/stderr

ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${WORK_ON} docklet-weave run ${NATIVE_IP}/24 \
		-v ${HOME_PREF}/${USER_NAME}/hosts-${NAT_ID}:/etc/hosts:ro \
		-v ${HOME_PREF}/${USER_NAME}/container-init:/sbin/initctl:ro \
		-v ${HOME_PREF}/${USER_NAME}/container-docklet:/usr/bin/docklet:ro \
		-v ${HOME_PREF}/${USER_NAME}/home:/root \
		-m ${TOTAL_MEMORY_LIMIT} -it ${NET_CONF} -h ${HOST_NAME} ${FOLK_FLAG} ${OPTS} ${IMAGE} /sbin/initctl ${NATIVE_IP} ${MASTER_IP} | cut -b 1-12

