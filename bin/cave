#!/bin/bash

. /etc/docklet/docklet.conf

HOME_PREF=${NFS_PREFIX}

[[ "`whoami`" != "root" ]] && echo "Root previledge required!" && exit 1

[[ "${NAT_ID}" == "" ]] && echo "NAT_ID not specified!" && exit 1
[[ "${HOST_NAME}" == "" ]] && echo "HOST_NAME not specified!" && exit 1
[[ "${USER_NAME}" == "" ]] && echo "USER_NAME not specified!" && exit 1
[[ "${IMAGE}" == "" ]] && echo "IMAGE not specified!" && exit 1
[[ "${NATIVE_IP}" == "" ]] && echo "NATIVE_IP not specified!" && exit 1
[[ "${WORK_ON}" == "" ]] && echo "WORK_ON not specified!" && exit 1

HOST_PROP=$(echo ${NATIVE_IP} | awk -F. '{print $4}')
MASTER_IP=$(basename ${NATIVE_IP} ${HOST_PROP})"0"

OPER=slave

if [[ "${HOST_NAME}" == "nat-master" ]]; then
	[[ "${BRIDGE_IP}" == "" ]] && echo "BRIDGE_IP not specified!" && exit 1
	[[ "${BRIDGE_GW}" == "" ]] && echo "BRIDGE_GW not specified!" && exit 1
	[[ "${BRIDGE_DEV}" == "" ]] && echo "BRIDGE_DEV not specified!" && exit 1
	OPER=master
	NET_CONF="--lxc-conf=\"lxc.network.type=veth\" --lxc-conf=\"lxc.network.ipv4=${BRIDGE_IP}\" --lxc-conf=\"lxc.network.ipv4.gateway=${BRIDGE_GW}\" --lxc-conf=\"lxc.network.link=${BRIDGE_DEV}\" --lxc-conf=\"lxc.network.name=ethex\" --lxc-conf=\"lxc.network.flags=up\""
fi

NAT_ID=${NAT_ID} USER_NAME=${USER_NAME} stone >/dev/null

nohup ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${WORK_ON} "docklet-weave ${OPER} ${NAME} ${NATIVE_IP} ${BRIDGE_IP}/24 ${BRIDGE_DEV} ${BRIDGE_GW} ${IMAGE}" >/dev/null 2>&1 &

exit

nohup ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${WORK_ON} " \
  lockfile-create /tmp/docklet-images-load; \
  USER_NAME=${USER_NAME} ham pull_2v ${IMAGE}; \
  lockfile-remove /tmp/docklet-images-load; \
  docklet-weave run ${NATIVE_IP} ${NAME} \
    -v ${HOME_PREF}/${USER_NAME}/hosts-${NAT_ID}:/etc/hosts:ro \
    -m ${TOTAL_MEMORY_LIMIT} -it --net=none ${NET_CONF} -h ${HOST_NAME} ${FOLK_FLAG} ${IMAGE} /sbin/initctl ${NATIVE_IP} ${MASTER_IP}" >/dev/null 2>&1 &

