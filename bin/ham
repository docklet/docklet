#!/bin/bash

. /etc/docklet/docklet.conf

HOME_PREF=${NFS_PREFIX}/global

mkdir -p ${HOME_PREF}/images

[[ "`whoami`" != "root" ]] && echo "Root previledge required!" && exit 1


if [[ "$1" == "push_2v" ]]; then
	[[ -e ${HOME_PREF}/images/pub_$2.tgz ]] && exit 0
	[[ -e ${HOME_PREF}/images/self_$2.tgz ]] && exit 0
	[[ "`docker inspect "$2" 2>/dev/null`" == "[]" ]] && exit 1
	
	lockfile-create /tmp/docklet-commit.lock
	rm -rf /tmp/docklet-commit-layers/ && mkdir -p /tmp/docklet-commit-layers/
	docker save "$2" | tar xvf - --exclude="1e868fd4a983baa2b698e29c86fced779eb993f88f89df55882c5814ff0697be/*" -C /tmp/docklet-commit-layers/
	cd /tmp/docklet-commit-layers/ && tar czvf ${HOME_PREF}/images/self_$2.tgz *
	rm -rf /tmp/docklet-commit-layers/
	lockfile-remove /tmp/docklet-commit.lock
elif [[ "$1" == "pull_3v" ]]; then
	TYPE=$(echo $2 | awk -F\_ '{print $1}')
	[[ "${TYPE}" == "skip" ]] && exit 0
	[[ ! -e ${HOME_PREF}/images/$2.tgz ]] && exit 1
	DOCKER_IMG=$(echo $2 | awk -F\_ '{print $2"_"$3}')
	[[ "`docker images | grep ${DOCKER_IMG}`" != "" ]] && exit 0
	docker load < ${HOME_PREF}/images/$2.tgz
elif [[ "$1" == "drop_3v" ]]; then
	rm -rf ${HOME_PREF}/images/$2.tgz
elif [[ "$1" == "switch_3v" ]]; then
	[[ "$2" == "" ]] && exit 1
	MOD="`echo $2 | awk -F\_ '{ print $1 }'`"
	OWN="`echo $2 | awk -F\_ '{ print $2 }'`"
	IMG="`echo $2 | awk -F\_ '{ print $3 }'`"
	if [[ "$MOD" == "self" ]]; then
		NEW_MOD="pub"
	else
		NEW_MOD="self"
	fi
	[[ ! -e ${HOME_PREF}/images/${MOD}_${OWN}_${IMG}.tgz ]] && exit 1
	mv ${HOME_PREF}/images/${MOD}_${OWN}_${IMG}.tgz ${HOME_PREF}/images/${NEW_MOD}_${OWN}_${IMG}.tgz
elif [[ "$1" == "list_3v" ]]; then
	[[ "${USER_NAME}" == "" ]] && echo "USER_NAME (like, root) not specified!" && exit 1
	
	! ls ${HOME_PREF}/images/*_*.tgz >/dev/null 2>&1 && exit 0
	
	for ITEM in `ls ${HOME_PREF}/images/*_*_*.tgz`; do
		IMAGE=`basename ${ITEM} .tgz`
		MOD="`echo ${IMAGE} | awk -F\_ '{ print $1 }'`"
		OWN="`echo ${IMAGE} | awk -F\_ '{ print $2 }'`"
		if [[ "${MOD}" == "pub" ]] || [[ "${OWN}" == "${USER_NAME}" ]] || [[ "root" == "${USER_NAME}" ]]; then
			echo "${IMAGE}:-"
		fi
	done
fi

