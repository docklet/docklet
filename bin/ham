#!/bin/bash

. /etc/docklet/docklet.conf

HOME_PREF=${NFS_PREFIX}/global

mkdir -p ${HOME_PREF}/images

[[ "`whoami`" != "root" ]] && echo "Root previledge required!" && exit 1


if [[ "$1" == "push_2v" ]]; then
	[[ -e ${HOME_PREF}/images/pub_$2.tgz ]] && exit 1
	[[ -e ${HOME_PREF}/images/self_$2.tgz ]] && exit 1
	[[ "`docker inspect "$2" 2>/dev/null`" == "[]" ]] && exit 1
	
	lockfile-create /tmp/docklet-commit.lock
	rm -rf /tmp/docklet-commit-layers/ && mkdir -p /tmp/docklet-commit-layers/
	docker save "$2" | tar xvf - --exclude="1e868fd4a983baa2b698e29c86fced779eb993f88f89df55882c5814ff0697be/*" -C /tmp/docklet-commit-layers/
	cd /tmp/docklet-commit-layers/ && tar czvf ${HOME_PREF}/images/self_$2.tgz *
	rm -rf /tmp/docklet-commit-layers/
	lockfile-remove /tmp/docklet-commit.lock
elif [[ "$1" == "pull_2v" ]]; then
	[[ -e ${HOME_PREF}/images/pub_$2.tgz ]] && MOD=pub
	[[ -e ${HOME_PREF}/images/self_$2.tgz ]] && MOD=self
	[[ "${MOD}" == "" ]] && exit 1
	
	OWNER=$(echo $2 | awk -F\_ '{print $1}')
	
	[[ "${USER_NAME}" != "${OWNER}" ]] && [[ "${MOD}" == "self" ]] && exit 1
	
	[[ "`docker images | grep $2`" != "" ]] && exit 0
	docker load < ${HOME_PREF}/images/${MOD}_$2.tgz
	
elif [[ "$1" == "drop_2v" ]]; then
	if [[ -e ${HOME_PREF}/images/pub_$2.tgz ]] || [[ -e ${HOME_PREF}/images/self_$2.tgz ]]; then
		rm -rf ${HOME_PREF}/images/pub_$2.tgz ${HOME_PREF}/images/self_$2.tgz
	else
		false
	fi
elif [[ "$1" == "switch_2v" ]]; then
	[[ "$2" == "" ]] && exit 1
	[[ -e ${HOME_PREF}/images/pub_$2.tgz ]] && MOD=pub && NEW_MOD=self
	[[ -e ${HOME_PREF}/images/self_$2.tgz ]] && MOD=self && NEW_MOD=pub
	[[ "${MOD}" == "" ]] && exit 1
	OWN="`echo $2 | awk -F\_ '{ print $1 }'`"
	IMG="`echo $2 | awk -F\_ '{ print $2 }'`"
	mv ${HOME_PREF}/images/${MOD}_${OWN}_${IMG}.tgz ${HOME_PREF}/images/${NEW_MOD}_${OWN}_${IMG}.tgz
elif [[ "$1" == "list_3v" ]]; then
	[[ "${USER_NAME}" == "" ]] && echo "USER_NAME (like, root) not specified!" && exit 1
	
	! ls ${HOME_PREF}/images/*_*.tgz >/dev/null 2>&1 && exit 0
	
	for ITEM in `ls ${HOME_PREF}/images/*_*_*.tgz`; do
		IMAGE=`basename ${ITEM} .tgz`
		MOD="`echo ${IMAGE} | awk -F\_ '{ print $1 }'`"
		OWN="`echo ${IMAGE} | awk -F\_ '{ print $2 }'`"
		if [[ "${MOD}" == "pub" ]] || [[ "${OWN}" == "${USER_NAME}" ]] || [[ "root" == "${USER_NAME}" ]]; then
			echo "${IMAGE}:-"
		fi
	done
fi

