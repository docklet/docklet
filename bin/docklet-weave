#!/bin/bash

set -e

. /etc/docklet/docklet.conf

TYPE=$1 ; shift
IPADDR=$1 ; shift
UUID=$1 ; shift

[[ "${TYPE}" != "run" ]] && [[ "${TYPE}" != "start" ]] && false

if [[ "${TYPE}" == "run" ]]; then
	docker run -d --name=${UUID} "$@" >/dev/null 2>&1
else
	docker start ${UUID} >/dev/null 2>&1
fi

LXCID=$(docker inspect ${UUID} | grep Id.: | awk -F\" '{print $4}')
if [[ "${LXCID}" != "" ]] && [[ -e "/sys/fs/cgroup/cpu/lxc/${LXCID}/tasks" ]]; then
	NSPID=$(cat "/sys/fs/cgroup/cpu/lxc/${LXCID}/tasks" | head -n 1)
	mkdir -p /var/run/netns
	rm -f /var/run/netns/$NSPID
	ln -s /proc/$NSPID/ns/net /var/run/netns/$NSPID
		
	LOCAL_IFNAME=vethl$NSPID
	GUEST_IFNAME=vethg$NSPID
	ip link add name $LOCAL_IFNAME type veth peer name $GUEST_IFNAME
	ip link set $LOCAL_IFNAME up
	ip link set $GUEST_IFNAME netns $NSPID
	ip netns exec $NSPID ip link set $GUEST_IFNAME name eth0
	ip netns exec $NSPID ip addr add ${IPADDR}/8 dev eth0
	ip netns exec $NSPID ip link set eth0 up
	brctl addif ovs-bridge $LOCAL_IFNAME
		
	rm -f /var/run/netns/$NSPID
fi

