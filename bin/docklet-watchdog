#!/bin/bash

. /etc/docklet/docklet.conf

if [[ "`whoami`" == "root" ]] && [[ "${HOST}" != "" ]]; then
	
	LEADER=$(curl -L http://0.0.0.0:4001/v2/stats/leader 2>/dev/null | python -m json.tool 2>/dev/null | grep leader | awk -F\" '{print $4}')
	
	if [[ "${LEADER}" == "${HOST}" ]]; then
		echo "* ${HOST}: I'm leader" > /dev/stderr
		if ! docklet-weave find core-service ; then
			echo "* ${HOST}: starting core-service .." > /dev/stderr
			
			HOST=${HOST} docklet-weave bridge core-service
			
		fi
		sleep 20
	else
		echo "* ${HOST}: I'm not leader" > /dev/stderr
		
		sleep 10
	fi
	
fi

