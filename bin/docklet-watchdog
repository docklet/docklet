#!/bin/bash

. /etc/docklet/docklet.conf

if [[ "`whoami`" == "root" ]] && [[ "${HOST}" != "" ]]; then
	
	LEADER=$(curl -L http://0.0.0.0:4001/v2/stats/leader 2>/dev/null | python -m json.tool 2>/dev/null | grep leader | awk -F\" '{print $4}')
	
	USER_NAME=root ham pull_2v root_base
	
	if [[ "${LEADER}" == "${HOST}" ]]; then
		echo "* ${HOST}: I'm leader" > /dev/stderr
		if ! ping -w 15 -c 1 ${PORTAL_CENTRE} >/dev/null 2>&1; then
			if ! docker inspect weave 2>/dev/null | grep Running | grep true >/dev/null || [[ "$(docker inspect --format='{{ .HostConfig.LxcConf }}' weave 2>/dev/null)" == "<no value>" ]]; then
				echo "* ${HOST}: Becomes the master" > /dev/stderr
				
				echo "*" `docklet-weave stop` `CIDR=${PORTAL_CENTRE} CGW=${PORTAL_GATEWAY} CBR=${PORTAL_BRIDGE} docklet-weave launch centre` > /dev/stderr
				
				NET_CONF="--net=none --lxc-conf=\"lxc.network.type=veth\" --lxc-conf=\"lxc.network.ipv4=${PORTAL_HTTP}/24\" --lxc-conf=\"lxc.network.ipv4.gateway=${PORTAL_GATEWAY}\" --lxc-conf=\"lxc.network.link=${PORTAL_BRIDGE}\" --lxc-conf=\"lxc.network.name=eth0\" --lxc-conf=\"lxc.network.flags=up\""
				docker run ${NET_CONF} --name=core_service \
					-v /root:/root:rw \
					-v ${NFS_PREFIX}:/mnt:ro \
					-v /usr/local/lib/docklet-http:/usr/local/lib/docklet-http:rw \
					-d -h docklet-core root_base /usr/local/lib/docklet-http/dl-coreinit ${HOST} ${NIS_SERVER}
			fi
		fi
		sleep 20
	else
		echo "* ${HOST}: I'm not leader" > /dev/stderr
		if ! docker inspect weave | grep Running | grep true >/dev/null 2>&1; then
			docklet-weave launch ${PORTAL_CENTRE}
		fi
		sleep 10
	fi
	
fi

