#!/bin/bash

( [[ "`whoami`" != "root" ]] || [[ "${HOST}" == "" ]] ) && exit 1

. /etc/docklet/docklet.conf

while true; do
	
	LEADER=$(curl -L http://0.0.0.0:4001/v2/stats/leader 2>/dev/null | python -m json.tool | grep leader | awk -F\" '{print $4}')
	
	ham pull_3v pub_root_base
	
	if [[ "${LEADER}" == "${HOST}" ]]; then
		echo "* ${HOST}: I'm leader" > /dev/stderr
		if ! ping -w 15 -c 1 ${PORTAL_CENTRE} >/dev/null 2>&1; then
			CONTAINER_PID=$(docker inspect --format='{{ .State.Pid }}' weave 2>/dev/null)
			if [[ "${CONTAINER_PID}" == "" ]] || [[ "$(docker inspect --format='{{ .HostConfig.LxcConf }}' weave)" == "<no value>" ]]; then
				echo "* ${HOST}: Becomes the master" > /dev/stderr
				
				echo "*" `docklet-weave stop` `CIDR=${PORTAL_CENTRE} CGW=${PORTAL_GATEWAY} CBR=${PORTAL_BRIDGE} docklet-weave launch centre` > /dev/stderr
				
				NET_CONF="--net=none --lxc-conf=\"lxc.network.type=veth\" --lxc-conf=\"lxc.network.ipv4=${PORTAL_HTTP}/24\" --lxc-conf=\"lxc.network.ipv4.gateway=${PORTAL_GATEWAY}\" --lxc-conf=\"lxc.network.link=${PORTAL_BRIDGE}\" --lxc-conf=\"lxc.network.name=eth0\" --lxc-conf=\"lxc.network.flags=up\""
				
				echo "docker run ${NET_CONF} \
					-v /root:/root:ro \
					-v /usr/local/lib/docklet-http:/usr/local/lib/docklet-http:ro \
					-d -h docklet-http root_base /usr/local/lib/docklet-http/dl-httpinit ${HOST}"
				docker run ${NET_CONF} \
					-v /root:/root:ro \
					-v /usr/local/lib/docklet-http:/usr/local/lib/docklet-http:ro \
					--privileged -d -h docklet-http root_base /usr/local/lib/docklet-http/dl-httpinit ${HOST} ${NIS_SERVER}
				
				# HTTP_PID=$(ps aux | grep docklet-http | grep -v grep | awk '{print $2}')
				# if [[ "${HTTP_PID}" == "" ]]; then
				# 	GROW_ON=${HOST} nohup docklet-http >/dev/null 2>&1 &
				# fi
			fi
		fi
		sleep 25
	else
		echo "* ${HOST}: I'm not leader" > /dev/stderr
		CONTAINER_PID=$(docker inspect --format='{{ .State.Pid }}' weave 2>/dev/null)
		if [[ "${CONTAINER_PID}" == "" ]]; then
			docklet-weave launch ${PORTAL_CENTRE}
		fi
		sleep 15
	fi
	
	# docker rmi $(docker images -q) 2>/dev/null
done

